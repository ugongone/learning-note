<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG精度評価アーキテクチャ | Langfuse x RAGAS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }
        .code-block {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            background-color: #1e293b;
            color: #e2e8f0;
        }
        /* Custom arrow markers for SVG */
        .arrow-head {
            fill: #94a3b8;
        }
        .arrow-head-purple {
            fill: #a855f7;
        }
        .arrow-head-green {
            fill: #84cc16;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="bg-slate-900 text-white py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">RAG精度評価アーキテクチャ</h1>
                    <p class="text-slate-400 text-sm mt-1">Langfuse (記録) × RAGAS (評価) による高精度かつセキュアな運用モデル</p>
                </div>
                <div class="hidden md:flex gap-4">
                    <span class="bg-slate-800 px-3 py-1 rounded text-xs border border-slate-700">Self-Hosted Ready</span>
                    <span class="bg-slate-800 px-3 py-1 rounded text-xs border border-slate-700">Internal Proxy Compatible</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-5xl">

        <!-- 1. The Concept (Role Definition) -->
        <section class="mb-12">
            <h2 class="text-xl font-bold text-slate-800 border-l-4 border-blue-500 pl-3 mb-6">1. 役割分担：餅は餅屋のアプローチ</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Langfuse Card -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden group hover:border-blue-400 transition">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-chart-line text-6xl text-blue-600"></i>
                    </div>
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600">
                            <i class="fa-solid fa-database"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800">Langfuse</h3>
                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full font-medium">記録・可視化</span>
                    </div>
                    <p class="text-sm text-slate-600 mb-4">
                        RAGアプリの実行ログ（Trace）を収集し、ダッシュボードとして表示するプラットフォーム。<br>
                        <a href="https://zenn.dev/cloud_ace/articles/44cb9bbcd92865" target="_blank" rel="noopener noreferrer" class="inline-flex items-center text-blue-600 hover:underline mt-2 font-medium relative z-10">
                            <i class="fa-solid fa-arrow-up-right-from-square mr-1"></i> 実際の利用イメージ (Zenn)
                        </a>
                    </p>
                    <ul class="text-sm space-y-2 text-slate-600">
                        <li class="flex items-start gap-2"><i class="fa-solid fa-check text-green-500 mt-1"></i> <span>会話ログの保存と検索</span></li>
                        <li class="flex items-start gap-2"><i class="fa-solid fa-check text-green-500 mt-1"></i> <span>コスト・レイテンシの管理</span></li>
                        <li class="flex items-start gap-2"><i class="fa-solid fa-check text-green-500 mt-1"></i> <span>評価スコアの表示と分析</span></li>
                    </ul>
                </div>

                <!-- RAGAS Card -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden group hover:border-purple-400 transition">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-calculator text-6xl text-purple-600"></i>
                    </div>
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center text-purple-600">
                            <i class="fa-solid fa-microchip"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800">RAGAS</h3>
                        <span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full font-medium">評価エンジン</span>
                    </div>
                    <p class="text-sm text-slate-600 mb-4">
                        RAG特有の指標（忠実度、関連性など）を計算するためのフレームワーク・ライブラリ。
                    </p>
                    <ul class="text-sm space-y-2 text-slate-600">
                        <li class="flex items-start gap-2"><i class="fa-solid fa-check text-green-500 mt-1"></i> <span>Faithfulness (ハルシネーション検知)</span></li>
                        <li class="flex items-start gap-2"><i class="fa-solid fa-check text-green-500 mt-1"></i> <span>Context Precision (検索精度の計測)</span></li>
                        <li class="flex items-start gap-2"><i class="fa-solid fa-check text-green-500 mt-1"></i> <span>社内LLMを使用した採点処理</span></li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- 2. Workflow Diagram (HTML/SVG) -->
        <section class="mb-12">
            <h2 class="text-xl font-bold text-slate-800 border-l-4 border-indigo-500 pl-3 mb-6">2. データフロー：システム連携図</h2>
            
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 overflow-x-auto">
                <div class="min-w-[700px] h-[400px] relative">
                    
                    <!-- --- Nodes Layer --- -->
                    
                    <!-- 1. App Node (Top Left) -->
                    <div class="absolute top-[40px] left-[50px] w-48 z-20">
                        <div class="bg-slate-100 rounded-lg p-4 border border-slate-300 shadow-sm relative bg-white">
                            <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Runtime</div>
                            <div class="bg-blue-600 text-white p-3 rounded shadow-md mb-2 flex items-center justify-center">
                                <i class="fa-solid fa-robot mr-2"></i>RAG App
                            </div>
                            <!-- Dot -->
                            <div class="absolute top-1/2 -right-1.5 w-3 h-3 bg-blue-500 rounded-full border border-white translate-x-1/2 -translate-y-1/2"></div>
                        </div>
                    </div>

                    <!-- 2. Langfuse Node (Top Center) -->
                    <div class="absolute top-[20px] left-[320px] w-64 z-20">
                        <div class="bg-slate-800 text-white rounded-xl p-6 shadow-xl border-2 border-blue-400 relative">
                            <div class="text-blue-300 text-xs font-bold uppercase tracking-wider mb-2 text-center">Data Hub</div>
                            <div class="text-lg font-bold text-center mb-1">Langfuse DB<span class="text-sm block font-normal text-slate-300">(PostgreSQL)</span></div>
                            <div class="text-xs text-slate-400 text-center mb-4">(Self-Hosted)</div>
                            <!-- Dots -->
                            <div class="absolute top-16 -left-1.5 w-3 h-3 bg-slate-500 rounded-full border border-white -translate-x-1/2"></div>
                            <div class="absolute top-16 -right-1.5 w-3 h-3 bg-slate-500 rounded-full border border-white translate-x-1/2"></div>
                            <div class="absolute -bottom-1.5 left-1/2 w-3 h-3 bg-green-500 rounded-full border border-white -translate-x-1/2"></div>
                            <div class="absolute top-[80%] -right-1.5 w-3 h-3 bg-purple-500 rounded-full border border-white translate-x-1/2"></div>
                        </div>
                    </div>

                    <!-- 3. RAGAS Node (Top Right) -->
                    <div class="absolute top-[40px] right-[50px] w-48 z-20">
                        <div class="bg-purple-50 rounded-lg p-4 border border-purple-200 shadow-sm relative bg-white">
                            <div class="text-purple-600 text-xs font-bold uppercase tracking-wider mb-2">Evaluation Job</div>
                            <div class="bg-purple-600 text-white p-3 rounded shadow-md mb-2 flex items-center justify-center">
                                <i class="fa-solid fa-gears mr-2"></i>RAGAS
                            </div>
                            <div class="text-xs text-center text-slate-500 mb-2">Batch Processing</div>
                            
                            <!-- Internal LLM Box -->
                            <div class="mt-2 bg-white border border-slate-200 p-2 rounded text-xs flex items-center justify-center gap-2 shadow-sm text-slate-500">
                                <i class="fa-solid fa-server"></i> 社内Proxy LLM
                            </div>

                            <!-- Dots -->
                            <div class="absolute top-10 -left-1.5 w-3 h-3 bg-purple-400 rounded-full border border-white -translate-x-1/2"></div>
                            <div class="absolute top-[75%] -left-1.5 w-3 h-3 bg-purple-500 rounded-full border border-white -translate-x-1/2"></div>
                        </div>
                    </div>

                    <!-- 4. Dashboard Node (Bottom Center) -->
                    <a href="https://zenn.dev/cloud_ace/articles/44cb9bbcd92865" target="_blank" rel="noopener noreferrer" class="absolute bottom-[40px] left-[320px] w-64 z-20 group block">
                        <div class="bg-green-50 rounded-xl p-4 border border-green-200 shadow-sm relative bg-white group-hover:border-green-400 group-hover:shadow-md transition-all">
                            <div class="text-green-600 text-xs font-bold uppercase tracking-wider mb-2 text-center">Human Check</div>
                            <div class="bg-green-600 text-white p-3 rounded shadow-md mb-2 flex items-center justify-center group-hover:bg-green-500 transition-colors">
                                <i class="fa-solid fa-desktop mr-2"></i>Langfuse UI
                            </div>
                            <div class="text-xs text-center text-slate-600">
                                開発者による分析・確認<br>
                                <span class="text-green-600 underline text-[10px] mt-1 inline-block"><i class="fa-solid fa-arrow-up-right-from-square mr-1"></i>利用イメージ (Zenn)</span>
                            </div>
                            <!-- Dot -->
                            <div class="absolute -top-1.5 left-1/2 w-3 h-3 bg-green-500 rounded-full border border-white -translate-x-1/2"></div>
                        </div>
                    </a>

                    <!-- --- SVG Lines Layer --- -->
                    <svg class="absolute top-0 left-0 w-full h-full pointer-events-none z-10" style="overflow: visible;">
                        <defs>
                            <marker id="arrow-gray" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" class="arrow-head" />
                            </marker>
                            <marker id="arrow-purple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" class="arrow-head-purple" />
                            </marker>
                            <marker id="arrow-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" class="arrow-head-green" />
                            </marker>
                        </defs>
                        
                        <!-- Line 1: App -> Langfuse -->
                        <path d="M 245 90 C 270 90, 290 85, 315 85" fill="none" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrow-gray)"/>
                        
                        <!-- Line 2: Langfuse -> RAGAS (Log Fetch) -->
                        <path d="M 585 85 C 610 85, 630 90, 655 90" fill="none" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrow-gray)"/>

                        <!-- Line 3: RAGAS -> Langfuse (Score Writeback - Curved Bottom) -->
                        <path d="M 655 160 C 630 160, 630 180, 590 170" fill="none" stroke="#a855f7" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrow-purple)"/>

                        <!-- Line 4: Langfuse -> Dashboard (Vertical Down) -->
                        <path d="M 448 220 L 448 245" fill="none" stroke="#84cc16" stroke-width="2" marker-end="url(#arrow-green)"/>
                    </svg>

                    <!-- --- Labels Layer --- -->
                    <!-- Label 1 -->
                    <div class="absolute top-[65px] left-[255px] bg-white border border-slate-200 px-1.5 py-0.5 rounded text-[10px] text-slate-500">
                        1. ログ送信
                    </div>
                    <!-- Label 2 -->
                    <div class="absolute top-[65px] right-[255px] bg-white border border-slate-200 px-1.5 py-0.5 rounded text-[10px] text-slate-500">
                        2. ログ取得
                    </div>
                    <!-- Label 3 -->
                    <div class="absolute top-[180px] right-[230px] bg-white border border-purple-200 px-1.5 py-0.5 rounded text-[10px] text-purple-600 font-bold">
                        4. スコア書込
                    </div>
                    <!-- Label 4 -->
                    <div class="absolute top-[225px] left-[460px] bg-white border border-green-200 px-1.5 py-0.5 rounded text-[10px] text-green-600 font-bold">
                        5. 結果確認
                    </div>

                </div>
            </div>
        </section>

        <!-- 3. Integration Logic (Code) -->
        <section class="mb-12">
            <h2 class="text-xl font-bold text-slate-800 border-l-4 border-slate-600 pl-3 mb-6">3. 実装イメージ (Python)</h2>
            <div class="bg-slate-900 rounded-xl overflow-hidden shadow-lg">
                <div class="bg-slate-800 px-4 py-2 flex items-center justify-between">
                    <span class="text-xs text-slate-400">evaluate_pipeline.py</span>
                    <div class="flex gap-1.5">
                        <div class="w-2.5 h-2.5 rounded-full bg-red-500"></div>
                        <div class="w-2.5 h-2.5 rounded-full bg-yellow-500"></div>
                        <div class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
                    </div>
                </div>
                <div class="p-6 overflow-x-auto">
<pre class="code-block text-sm leading-relaxed"><code><span class="text-purple-400">from</span> langfuse <span class="text-purple-400">import</span> Langfuse
<span class="text-purple-400">from</span> ragas <span class="text-purple-400">import</span> evaluate
<span class="text-purple-400">from</span> ragas.metrics <span class="text-purple-400">import</span> faithfulness, answer_relevancy

<span class="text-gray-500"># 1. Langfuseから評価対象のTraceを取得</span>
langfuse = Langfuse()
traces = langfuse.get_traces(limit=<span class="text-blue-400">10</span>, tags=[<span class="text-green-400">"production"</span>])

<span class="text-gray-500"># 2. RAGAS用にデータを変換 & 評価実行</span>
<span class="text-gray-500"># (ここで社内LLMを使用して計算が行われます)</span>
results = evaluate(
    dataset=transform_to_ragas_dataset(traces),
    metrics=[faithfulness, answer_relevancy]
)

<span class="text-gray-500"># 3. 計算結果(スコア)をLangfuseに書き戻す</span>
<span class="text-purple-400">for</span> i, trace <span class="text-purple-400">in</span> <span class="text-yellow-300">enumerate</span>(traces):
    langfuse.score(
        trace_id=trace.id,
        name=<span class="text-green-400">"Faithfulness"</span>,
        value=results[i][<span class="text-green-400">"faithfulness"</span>],
        comment=<span class="text-green-400">"Automated by RAGAS"</span>
    )</code></pre>
                </div>
            </div>
            <p class="mt-4 text-sm text-slate-600 bg-yellow-50 p-4 rounded border border-yellow-200">
                <i class="fa-solid fa-lightbulb text-yellow-500 mr-2"></i>
                <strong>ポイント:</strong> このスクリプトはアプリ本体とは別のプロセス（CI/CDや夜間バッチ）で実行するため、アプリの応答速度には一切影響を与えません。
            </p>
        </section>

        <!-- 4. Dataset Evolution -->
        <section class="mb-12">
            <h2 class="text-xl font-bold text-slate-800 border-l-4 border-emerald-500 pl-3 mb-6">4. 正解データの進化：Golden Datasetの更新</h2>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <div class="flex gap-4 items-start mb-6">
                    <div class="w-12 h-12 flex-shrink-0 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600">
                        <i class="fa-solid fa-rotate-right text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-800 mb-2">生成結果が「正解」を超える場合</h3>
                        <p class="text-sm text-slate-600 leading-relaxed">
                            運用を続けると、<strong>LLMの生成した回答が、元々用意していた正解データ(Ground Truth)よりも高品質または最新</strong>であるケースが発生します。
                            これを単なる「不一致（スコア低下）」として切り捨てず、新たな正解としてデータセットに取り込むフィードバックループを構築します。
                        </p>
                    </div>
                </div>

                <!-- Steps Diagram (Fixed to horizontal layout) -->
                <div class="flex flex-col md:flex-row gap-2 items-center text-center">
                    <!-- Step 1 -->
                    <div class="relative bg-slate-50 p-4 rounded-lg border border-slate-200 hover:border-emerald-300 transition group flex-1 w-full">
                        <div class="absolute -top-3 -left-3 w-8 h-8 bg-emerald-500 text-white rounded-full flex items-center justify-center font-bold text-sm">1</div>
                        <div class="text-slate-700 font-bold mb-2">候補の抽出</div>
                        <div class="text-xs text-slate-500 text-left space-y-2">
                            <div class="flex items-center gap-2"><i class="fa-regular fa-thumbs-up text-blue-500"></i> ユーザーの高評価</div>
                            <div class="flex items-center gap-2"><i class="fa-solid fa-robot text-purple-500"></i> LLM評価で"Better"判定</div>
                        </div>
                    </div>

                    <!-- Arrow -->
                    <div class="flex items-center justify-center flex-shrink-0">
                        <i class="fa-solid fa-arrow-right text-slate-300 text-xl md:block hidden"></i>
                        <i class="fa-solid fa-arrow-down text-slate-300 text-xl md:hidden block"></i>
                    </div>

                    <!-- Step 2 -->
                    <div class="relative bg-slate-50 p-4 rounded-lg border border-slate-200 hover:border-emerald-300 transition group flex-1 w-full">
                        <div class="absolute -top-3 -left-3 w-8 h-8 bg-emerald-500 text-white rounded-full flex items-center justify-center font-bold text-sm">2</div>
                        <div class="text-slate-700 font-bold mb-2">人間によるレビュー</div>
                        <div class="text-xs text-slate-500">
                            「旧正解」と「新回答」を比較。<br>
                            本当に新しい回答が優れていれば、Langfuse上のデータセットを更新する。
                        </div>
                        <div class="mt-2 bg-white border border-slate-200 rounded px-2 py-1 text-xs text-emerald-600 font-mono">
                            Human-in-the-loop
                        </div>
                    </div>

                    <!-- Arrow -->
                    <div class="flex items-center justify-center flex-shrink-0">
                        <i class="fa-solid fa-arrow-right text-slate-300 text-xl md:block hidden"></i>
                        <i class="fa-solid fa-arrow-down text-slate-300 text-xl md:hidden block"></i>
                    </div>

                    <!-- Step 3 -->
                    <div class="relative bg-emerald-50 p-4 rounded-lg border border-emerald-200 flex-1 w-full">
                        <div class="absolute -top-3 -left-3 w-8 h-8 bg-emerald-600 text-white rounded-full flex items-center justify-center font-bold text-sm shadow-sm">3</div>
                        <div class="text-emerald-800 font-bold mb-2">Dataset更新</div>
                        <div class="text-xs text-emerald-700 mb-2">
                            Golden Dataset (正解集) が進化し、次回のテストから新基準で評価される。
                        </div>
                        <i class="fa-solid fa-database text-emerald-400 text-2xl"></i>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-slate-100 border-t border-slate-200 mt-12 py-8">
        <div class="container mx-auto px-4 text-center text-slate-500 text-sm">
            <p>この構成により、<strong>「データセキュリティ（社内完結）」</strong>と<strong>「高度なRAG分析」</strong>の両立が可能になります。</p>
        </div>
    </footer>

</body>
</html>